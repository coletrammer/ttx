#pragma once

#include "di/container/vector/prelude.h"
#include "di/reflect/prelude.h"
#include "di/types/integers.h"
#include "ttx/terminal/absolute_position.h"

namespace ttx::terminal {
/// @brief Represents the result of reflowing a RowGroup
///
/// Reflow is the process of adjusting the text in a row group to fit into
/// a different number of columns. This process can add or remove rows to a row
/// group, as well as change the column offset of text within a row which was
/// reflowed.
///
/// The reflow result describes how to map a absolute position from before the
/// reflow operation to the correct coordinates after the reflow. This result is
/// described in terms of delta's which apply to a certain range of coordinates.
/// This means that looking up the offset to apply to a given position can be done
/// using a binary search. Only the start of each range is recorded in the result,
/// so the end of the range is implied by the start of the next range.
class ReflowResult {
private:
    struct ReflowRange {
        AbsolutePosition position;
        i64 dr = 0;
        i32 dc = 0;
        bool absolute_column { false };

        auto operator==(ReflowRange const&) const -> bool = default;

        constexpr friend auto tag_invoke(di::Tag<di::reflect>, di::InPlaceType<ReflowRange>) {
            return di::make_fields<"ReflowRange">(di::field<"position", &ReflowRange::position>,
                                                  di::field<"dr", &ReflowRange::dr>, di::field<"dc", &ReflowRange::dc>,
                                                  di::field<"absolute_column", &ReflowRange::absolute_column>);
        }
    };

public:
    /// @brief Add an offset for the given position to map to new coordinates
    ///
    /// @warning The offsets must be provided sequentially with respect to the provied
    /// position. This is asserted by the implementation.
    void add_offset(AbsolutePosition position, i64 dr, i32 dc, bool absolute_column = false);

    /// @brief Merge another reflow result with this one.
    ///
    /// @warning The provided ReflowResult must not overlap with this one. This is intended
    /// to be used with ReflowResult's generated by separate row groups in the same screen.
    void merge(ReflowResult&& other);

    /// @brief Map a provided position into the new coordinate space
    auto map_position(AbsolutePosition position) const -> AbsolutePosition;

    auto operator==(ReflowResult const&) const -> bool = default;

    constexpr friend auto tag_invoke(di::Tag<di::reflect>, di::InPlaceType<ReflowResult>) {
        return di::make_fields<"ReflowResult">(di::field<"ranges", &ReflowResult::m_ranges>);
    }

private:
    di::Vector<ReflowRange> m_ranges;
};
}
